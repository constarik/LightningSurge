<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chain Lightning - Play</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
      padding: 20px;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 0 20px #00d4ff, 0 0 40px #00d4ff;
      letter-spacing: 3px;
    }
    
    .mode-switch {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .mode-switch label {
      font-size: 0.9rem;
      color: #aaa;
    }
    
    .mode-switch select {
      background: #1a1a2e;
      color: #00d4ff;
      border: 1px solid #00d4ff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      font-size: 1rem;
    }
    
    .stat {
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .stat-value {
      font-weight: bold;
      color: #00d4ff;
      font-size: 1.1rem;
    }
    
    .main-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    
    .left-panel {
      width: 180px;
      min-height: 300px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .left-panel h3 {
      color: #00d4ff;
      margin-bottom: 8px;
      font-size: 0.85rem;
      text-transform: uppercase;
    }
    
    .chain-list {
      font-size: 0.8rem;
      line-height: 1.5;
    }
    
    .chain-list div {
      padding: 2px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .no-win {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ff6b6b;
      text-align: center;
      margin-top: 40px;
    }
    
    .grid-container {
      background: rgba(0,0,0,0.4);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 25px rgba(0,212,255,0.3);
      position: relative;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(6, 55px);
      grid-template-rows: repeat(5, 55px);
      gap: 4px;
    }
    
    .cell {
      width: 55px;
      height: 55px;
      background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      border: 2px solid #333;
      transition: all 0.15s ease;
      position: relative;
    }
    
    .cell.wild {
      background: linear-gradient(145deg, #ffd700, #ff8c00);
      box-shadow: 0 0 12px rgba(255,215,0,0.5);
    }
    
    .cell.struck {
      animation: strike 0.3s ease-out;
      border-color: #00d4ff;
      box-shadow: 0 0 15px #00d4ff;
      z-index: 10;
    }
    
    .cell.chain {
      background: linear-gradient(145deg, #00d4ff, #0077ff);
      border-color: #fff;
      box-shadow: 0 0 12px #00d4ff;
    }
    
    @keyframes strike {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); background: #fff; }
      100% { transform: scale(1); }
    }
    
    .wild-mode-banner {
      color: #ffd700;
      font-weight: bold;
      font-size: 1rem;
      text-align: center;
      margin-bottom: 8px;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
      min-height: 24px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    button {
      background: linear-gradient(145deg, #00d4ff, #0077ff);
      border: none;
      color: #fff;
      padding: 12px 30px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(0,212,255,0.4);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,212,255,0.6);
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    button.stop {
      background: linear-gradient(145deg, #ff6b6b, #cc5555);
    }
    
    .win-display {
      font-size: 1.8rem;
      min-height: 40px;
      color: #ffd700;
      text-shadow: 0 0 10px #ffd700;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
    }
    
    .server-status {
      font-size: 0.8rem;
      color: #888;
      margin-top: 10px;
    }
    
    .server-status.connected { color: #4f4; }
    .server-status.disconnected { color: #f44; }
  </style>
</head>
<body>
  <h1>‚ö° CHAIN LIGHTNING ‚ö°</h1>
  
  <div class="mode-switch">
    <label>Mode:</label>
    <select id="modeSelect" onchange="switchMode()">
      <option value="local">Local (JS)</option>
      <option value="server">Server (Java)</option>
    </select>
    <span class="server-status" id="serverStatus"></span>
  </div>
  
  <div class="stats">
    <div class="stat">Balance: <span class="stat-value" id="balance">10000</span></div>
    <div class="stat">Bet: <span class="stat-value" id="betDisplay">100</span></div>
    <div class="stat">Spin: <span class="stat-value" id="spinCount">0</span></div>
    <div class="stat">3+ Wilds: <span class="stat-value" id="wildModeCount">0</span></div>
    <div class="stat">Mult: <span class="stat-value" id="currentMult">√ó1</span></div>
  </div>
  
  <div class="main-area">
    <div class="left-panel">
      <h3>Chains</h3>
      <div class="chain-list" id="chainList"></div>
    </div>
    
    <div>
      <div class="wild-mode-banner" id="wildModeBanner"></div>
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>
  
  <div class="win-display" id="winDisplay"></div>
  
  <div class="controls">
    <button id="spinBtn" onclick="spin()">‚ö° SPIN ‚ö°</button>
    <button id="autoBtn" onclick="toggleAuto()">AUTO</button>
  </div>

<script>
// Config - will be loaded from server or use defaults
let CONFIG = {
  grid: { rows: 5, cols: 6 },
  bet: 100,
  symbols: {
    weights: [0, 7.0, 9.0, 11.0, 15.0, 17.0, 19.0, 22.0, 24.0, 26.0],
    emojis: ['‚ö°', 'üå©Ô∏è', 'ü¶Ö', 'üêâ', 'ü•Å', 'üé≠', 'üèÆ', 'üå™Ô∏è', 'üåä', '‚òÅÔ∏è'],
    names: ['Wild', 'ThunderGod', 'StormEagle', 'CloudSerpent', 'RainDrum', 'WindMask', 'StormLantern', 'Tornado', 'Wave', 'StormCloud']
  },
  lightning: {
    strikesPerSpin: 3,
    wildProb: 0.0179,
    multipliers: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
  },
  wildMode: {
    minWilds: 3,
    multiplier: 5
  },
  paytable: {
    1: [15, 40, 100, 200, 600, 1500],
    2: [10, 30, 70, 150, 500, 1000],
    3: [9, 25, 60, 150, 350, 900],
    4: [7, 20, 40, 125, 300, 700],
    5: [6, 15, 35, 100, 200, 500],
    6: [4, 10, 30, 75, 150, 400],
    7: [4, 9, 25, 60, 130, 350],
    8: [3, 7, 20, 50, 110, 250],
    9: [2, 6, 15, 40, 100, 200]
  }
};

let balance = 10000;
let grid = [];
let isSpinning = false;
let isAutoMode = false;
let spinNumber = 0;
let wildModeCount = 0;
let mode = 'local';
let serverUrl = 'http://localhost:8080';

let totalWeight = 0;

function initWeights() {
  totalWeight = 0;
  for (let i = 1; i < CONFIG.symbols.weights.length; i++) {
    totalWeight += CONFIG.symbols.weights[i];
  }
}

function pickSymbol() {
  let roll = Math.random() * totalWeight;
  for (let i = 1; i < CONFIG.symbols.weights.length; i++) {
    roll -= CONFIG.symbols.weights[i];
    if (roll <= 0) return i;
  }
  return CONFIG.symbols.weights.length - 1;
}

function generateGrid() {
  grid = [];
  for (let r = 0; r < CONFIG.grid.rows; r++) {
    const row = [];
    for (let c = 0; c < CONFIG.grid.cols; c++) {
      row.push(Math.random() < CONFIG.lightning.wildProb ? 0 : pickSymbol());
    }
    grid.push(row);
  }
  return grid;
}

function renderGrid() {
  const gridEl = document.getElementById('grid');
  gridEl.innerHTML = '';
  for (let r = 0; r < CONFIG.grid.rows; r++) {
    for (let c = 0; c < CONFIG.grid.cols; c++) {
      const cell = document.createElement('div');
      cell.className = 'cell' + (grid[r][c] === 0 ? ' wild' : '');
      cell.id = `cell-${r}-${c}`;
      cell.textContent = CONFIG.symbols.emojis[grid[r][c]];
      gridEl.appendChild(cell);
    }
  }
}

function getNeighbors(r, c) {
  const neighbors = [];
  for (let dr = -1; dr <= 1; dr++) {
    for (let dc = -1; dc <= 1; dc++) {
      if (dr === 0 && dc === 0) continue;
      const nr = r + dr, nc = c + dc;
      if (nr >= 0 && nr < CONFIG.grid.rows && nc >= 0 && nc < CONFIG.grid.cols) {
        neighbors.push([nr, nc]);
      }
    }
  }
  return neighbors;
}

function traceChain(startR, startC, usedCells) {
  const symbol = grid[startR][startC];
  if (symbol === 0) return { length: 0, symbol: 0, path: [] };
  if (usedCells.has(`${startR},${startC}`)) return { length: 0, symbol: 0, path: [] };
  
  const visited = new Set();
  const path = [[startR, startC]];
  visited.add(`${startR},${startC}`);
  
  let current = [startR, startC];
  
  while (true) {
    const neighbors = getNeighbors(current[0], current[1]);
    const candidates = neighbors.filter(([nr, nc]) => {
      const key = `${nr},${nc}`;
      const cell = grid[nr][nc];
      return !visited.has(key) && !usedCells.has(key) && (cell === symbol || cell === 0);
    });
    
    if (candidates.length === 0) break;
    
    const next = candidates[Math.floor(Math.random() * candidates.length)];
    visited.add(`${next[0]},${next[1]}`);
    path.push(next);
    current = next;
  }
  
  return { length: path.length, symbol, path };
}

function findWilds() {
  const wilds = [];
  for (let r = 0; r < CONFIG.grid.rows; r++) {
    for (let c = 0; c < CONFIG.grid.cols; c++) {
      if (grid[r][c] === 0) wilds.push([r, c]);
    }
  }
  return wilds;
}

function traceChainFromWild(startR, startC, usedCells) {
  const neighbors = getNeighbors(startR, startC);
  let bestChain = { length: 0, symbol: 0, path: [] };
  
  for (const [nr, nc] of neighbors) {
    if (usedCells.has(`${nr},${nc}`)) continue;
    const symbol = grid[nr][nc];
    if (symbol === 0) continue;
    
    const chain = traceChain(nr, nc, usedCells);
    if (chain.length > bestChain.length) {
      bestChain = chain;
    }
  }
  
  return { ...bestChain, wildStart: [startR, startC] };
}

function getPayout(symbol, chainLength) {
  if (chainLength < 3) return 0;
  const idx = Math.min(chainLength - 3, 5);
  return CONFIG.paytable[symbol][idx];
}

function getMultiplier(chainLength) {
  const idx = Math.min(chainLength - 1, CONFIG.lightning.multipliers.length - 1);
  return CONFIG.lightning.multipliers[idx];
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function spinLocal() {
  generateGrid();
  renderGrid();
  
  await sleep(200);
  
  let totalWin = 0;
  const usedCells = new Set();
  const chains = [];
  
  const wilds = findWilds();
  const isWildMode = wilds.length >= CONFIG.wildMode.minWilds;
  const wildMultiplier = isWildMode ? CONFIG.wildMode.multiplier : 1;
  
  if (isWildMode) {
    wildModeCount++;
    document.getElementById('wildModeCount').textContent = wildModeCount;
    document.getElementById('currentMult').textContent = `√ó${wildMultiplier}`;
    document.getElementById('currentMult').style.color = '#ffd700';
    document.getElementById('wildModeBanner').textContent = `‚ö° ${wilds.length} WILDS ‚Äî √ó${wildMultiplier} MODE! ‚ö°`;
    await sleep(400);
    
    for (const [wr, wc] of wilds) {
      if (usedCells.has(`${wr},${wc}`)) continue;
      
      const chain = traceChainFromWild(wr, wc, usedCells);
      
      if (chain.length >= 3 && chain.symbol > 0) {
        const basePay = getPayout(chain.symbol, chain.length);
        const mult = getMultiplier(chain.length);
        const win = basePay * mult * wildMultiplier;
        totalWin += win;
        
        chains.push({ ...chain, win, mult, basePay, wildMultiplier });
        usedCells.add(`${wr},${wc}`);
        chain.path.forEach(([r, c]) => usedCells.add(`${r},${c}`));
      }
    }
  } else {
    for (let strike = 0; strike < CONFIG.lightning.strikesPerSpin; strike++) {
      let attempts = 0;
      let startR, startC;
      
      do {
        startR = Math.floor(Math.random() * CONFIG.grid.rows);
        startC = Math.floor(Math.random() * CONFIG.grid.cols);
        attempts++;
      } while (usedCells.has(`${startR},${startC}`) && attempts < 30);
      
      if (attempts >= 30) continue;
      
      const chain = traceChain(startR, startC, usedCells);
      
      if (chain.length >= 3 && chain.symbol > 0) {
        const basePay = getPayout(chain.symbol, chain.length);
        const mult = getMultiplier(chain.length);
        const win = basePay * mult;
        totalWin += win;
        
        chains.push({ ...chain, win, mult, basePay, wildMultiplier: 1 });
        chain.path.forEach(([r, c]) => usedCells.add(`${r},${c}`));
      }
    }
    
    if (chains.length > 0) {
      const lastMult = chains[chains.length - 1].mult;
      document.getElementById('currentMult').textContent = `√ó${lastMult}`;
      document.getElementById('currentMult').style.color = '#00d4ff';
    }
  }
  
  // Animate chains
  const chainListEl = document.getElementById('chainList');
  for (const ch of chains) {
    for (const [r, c] of ch.path) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      cell.classList.add('struck', 'chain');
      await sleep(50);
    }
    
    let chainText = `${CONFIG.symbols.names[ch.symbol]} x${ch.length}: ${ch.basePay} √ó ${ch.mult}`;
    if (ch.wildMultiplier > 1) chainText += ` √ó ${ch.wildMultiplier}`;
    chainText += ` = ${ch.win}`;
    
    const div = document.createElement('div');
    div.textContent = chainText;
    chainListEl.appendChild(div);
    
    await sleep(200);
  }
  
  return totalWin;
}

async function spinServer() {
  try {
    const response = await fetch(`${serverUrl}/api/spin`);
    const data = await response.json();
    
    grid = data.grid;
    renderGrid();
    
    await sleep(200);
    
    if (data.wildMode) {
      wildModeCount++;
      document.getElementById('wildModeCount').textContent = wildModeCount;
      document.getElementById('currentMult').textContent = `√ó${data.wildModeMultiplier}`;
      document.getElementById('currentMult').style.color = '#ffd700';
      document.getElementById('wildModeBanner').textContent = `‚ö° ${data.wildCount} WILDS ‚Äî √ó${data.wildModeMultiplier} MODE! ‚ö°`;
      await sleep(400);
    }
    
    const chainListEl = document.getElementById('chainList');
    for (const ch of data.chains) {
      for (const cell of ch.path) {
        const cellEl = document.getElementById(`cell-${cell[0]}-${cell[1]}`);
        cellEl.classList.add('struck', 'chain');
        await sleep(50);
      }
      
      let chainText = `${ch.symbolName} x${ch.length}: ${ch.basePay} √ó ${ch.mult}`;
      if (ch.wildMult > 1) chainText += ` √ó ${ch.wildMult}`;
      chainText += ` = ${ch.win}`;
      
      const div = document.createElement('div');
      div.textContent = chainText;
      chainListEl.appendChild(div);
      
      await sleep(200);
    }
    
    if (!data.wildMode && data.chains.length > 0) {
      const lastMult = data.chains[data.chains.length - 1].mult;
      document.getElementById('currentMult').textContent = `√ó${lastMult}`;
      document.getElementById('currentMult').style.color = '#00d4ff';
    }
    
    return data.totalWin;
    
  } catch (error) {
    console.error('Server error:', error);
    document.getElementById('serverStatus').textContent = 'Disconnected';
    document.getElementById('serverStatus').className = 'server-status disconnected';
    return 0;
  }
}

async function spin() {
  if (isSpinning || balance < CONFIG.bet) return;
  isSpinning = true;
  document.getElementById('spinBtn').disabled = true;
  
  spinNumber++;
  document.getElementById('spinCount').textContent = spinNumber;
  
  balance -= CONFIG.bet;
  updateBalance();
  document.getElementById('winDisplay').textContent = '';
  document.getElementById('chainList').innerHTML = '';
  document.getElementById('wildModeBanner').textContent = '';
  
  let totalWin = 0;
  
  if (mode === 'local') {
    totalWin = await spinLocal();
  } else {
    totalWin = await spinServer();
  }
  
  if (totalWin > 0) {
    balance += totalWin;
    updateBalance();
    document.getElementById('winDisplay').textContent = `WIN: ${totalWin}`;
  } else {
    document.getElementById('chainList').innerHTML = '<div class="no-win">NO WIN</div>';
  }
  
  isSpinning = false;
  document.getElementById('spinBtn').disabled = false;
  
  if (isAutoMode && balance >= CONFIG.bet) {
    await sleep(300);
    spin();
  }
}

function toggleAuto() {
  isAutoMode = !isAutoMode;
  const btn = document.getElementById('autoBtn');
  if (isAutoMode) {
    btn.textContent = 'STOP';
    btn.classList.add('stop');
    if (!isSpinning) spin();
  } else {
    btn.textContent = 'AUTO';
    btn.classList.remove('stop');
  }
}

function updateBalance() {
  document.getElementById('balance').textContent = balance;
}

async function switchMode() {
  mode = document.getElementById('modeSelect').value;
  const statusEl = document.getElementById('serverStatus');
  
  if (mode === 'server') {
    statusEl.textContent = 'Connecting...';
    statusEl.className = 'server-status';
    
    try {
      const response = await fetch(`${serverUrl}/api/config`);
      const config = await response.json();
      
      // Update CONFIG from server
      CONFIG.grid.rows = config.rows;
      CONFIG.grid.cols = config.cols;
      CONFIG.bet = config.bet;
      CONFIG.symbols.names = config.symbolNames;
      CONFIG.symbols.weights = config.symbolWeights;
      CONFIG.lightning.wildProb = config.wildProb;
      CONFIG.lightning.strikesPerSpin = config.strikesPerSpin;
      CONFIG.lightning.multipliers = config.multipliers;
      CONFIG.wildMode.minWilds = config.minWildsForMode;
      CONFIG.wildMode.multiplier = config.wildModeMultiplier;
      CONFIG.paytable = config.paytable;
      
      document.getElementById('betDisplay').textContent = CONFIG.bet;
      
      statusEl.textContent = 'Connected';
      statusEl.className = 'server-status connected';
      
    } catch (error) {
      statusEl.textContent = 'Failed to connect';
      statusEl.className = 'server-status disconnected';
      document.getElementById('modeSelect').value = 'local';
      mode = 'local';
    }
  } else {
    statusEl.textContent = '';
  }
}

// Init
initWeights();
generateGrid();
renderGrid();
</script>
</body>
</html>
